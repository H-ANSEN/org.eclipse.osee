/*******************************************************************************
 * Copyright (c) 2004, 2007 Boeing.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     Boeing - initial API and implementation
 *******************************************************************************/
package org.eclipse.osee.ats.actions;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.logging.Level;
import org.eclipse.core.runtime.IProgressMonitor;
import org.eclipse.jface.action.Action;
import org.eclipse.jface.resource.ImageDescriptor;
import org.eclipse.osee.ats.artifact.AtsAttributeTypes;
import org.eclipse.osee.ats.artifact.TeamWorkFlowArtifact;
import org.eclipse.osee.ats.internal.AtsPlugin;
import org.eclipse.osee.ats.util.AtsBranchManager;
import org.eclipse.osee.ats.world.WorldEditor;
import org.eclipse.osee.framework.core.enums.CoreBranches;
import org.eclipse.osee.framework.core.exception.OseeCoreException;
import org.eclipse.osee.framework.core.exception.OseeStateException;
import org.eclipse.osee.framework.core.model.Branch;
import org.eclipse.osee.framework.core.model.TransactionRecord;
import org.eclipse.osee.framework.core.operation.AbstractOperation;
import org.eclipse.osee.framework.core.operation.IOperation;
import org.eclipse.osee.framework.core.operation.Operations;
import org.eclipse.osee.framework.logging.OseeLog;
import org.eclipse.osee.framework.skynet.core.artifact.Artifact;
import org.eclipse.osee.framework.skynet.core.artifact.search.ArtifactQuery;
import org.eclipse.osee.framework.skynet.core.change.Change;
import org.eclipse.osee.framework.skynet.core.revision.ChangeManager;
import org.eclipse.osee.framework.skynet.core.transaction.TransactionManager;
import org.eclipse.osee.framework.skynet.core.types.IArtifact;
import org.eclipse.osee.framework.ui.skynet.FrameworkImage;
import org.eclipse.osee.framework.ui.skynet.render.word.WordChangeReportOperation;
import org.eclipse.osee.framework.ui.swt.ImageManager;

/**
 * @author Donald G. Dunne
 */
public class ExportChangeReportsAction extends Action {
   private final WorldEditor worldEditor;
   private final boolean reverse = true;

   public ExportChangeReportsAction(WorldEditor worldEditor) {
      setText("Export Change Report(s)");
      setImageDescriptor(getImageDescriptor());
      this.worldEditor = worldEditor;
   }

   public Collection<TeamWorkFlowArtifact> getWorkflows() throws OseeCoreException {
      if (true) {
         Collection<String> dontCreate =
               Arrays.asList(new String[] {});

         Collection<String> legacyIds =
               Arrays.asList(new String[] {"10320", "10331", "10578", "10594", "10599", "10607", "10635", "10735",
                     "10766", "11129", "11146", "11151", "11205", "11213", "11223", "11224", "11233", "11239", "11244",
                     "11257", "11261", "11265", "11266", "11271", "11292", "11311", "11314", "11316", "11327", "11329",
                     "11337", "11338", "11339", "11352", "11357", "11365", "11373", "11374", "11375", "11380", "11382",
                     "11387", "11408", "11409", "11412", "11414", "11415", "11416", "11419", "11436", "11437", "11458",
                     "11461", "11464", "11485", "11486", "11493", "11495", "11498", "11499", "11501", "11504", "11505",
                     "11508", "11510", "11518", "11524", "11525", "11526", "11528", "11529", "11535", "11547", "11553",
                     "11554", "11555", "11556", "11557", "11558", "11560", "11563", "11573", "11575", "11576", "11595",
                     "11598", "11599", "11601", "11607", "11620", "11621", "11648", "11678", "11712", "11716", "11718",
                     "11737", "11751", "11767", "11769", "11777", "11778", "11779", "11783", "11801", "12082", "12097",
                     "12101", "12103", "9956", "12118", "12169", "10679", "10755", "10785", "10862", "10897", "10929",
                     "10977", "11099", "11136", "11147", "11154", "11155", "11202", "11255", "11294", "11299", "11347",
                     "11403", "11423", "11487", "11502", "11546", "11580", "11719", "11744", "11776", "11787", "11896",
                     "11910", "11989", "12034", "12038", "12042", "10031", "10096", "10117", "10118", "10131", "10132",
                     "10142", "10224", "10260", "10349", "10352", "10361", "10362", "10373", "10422", "10424", "10432",
                     "10437", "10438", "10600", "10654", "10659", "11610", "11619", "11650", "11680", "11782", "11799",
                     "11800", "11851", "11872", "11888", "11950", "11955", "12011", "12018", "12021", "10017", "10071",
                     "10088", "10124", "10270", "10282", "10283", "10365", "10386", "10590", "10631", "10633", "10758",
                     "10942", "11051", "11276", "11285", "11287", "11303", "11353", "11401", "11425", "11468", "11500",
                     "11517", "11548", "11559", "11572", "11589", "10048", "10050", "10052", "10053", "10054", "10059",
                     "10062", "10063", "10065", "10066", "10070", "10074", "10076", "10077", "10081", "10082", "10084",
                     "10085", "10089", "10092", "10093", "10094", "10095", "10100", "10101", "10104", "10106", "10107",
                     "10108", "10109", "10111", "10112", "10113", "10115", "10119", "10123", "10125", "10126", "10127",
                     "10128", "10129", "10130", "10133", "10137", "10144", "10145", "10146", "10147", "10149", "10150",
                     "10151", "10152", "10153", "10173", "10174", "10175", "10176", "10177", "10178", "10179", "10180",
                     "10186", "10188", "10190", "10203", "10205", "10207", "10214", "10216", "10217", "10222", "10225",
                     "10226", "10227", "10228", "10229", "10230", "10231", "10232", "10233", "10234", "10235", "10236",
                     "10239", "10240", "10241", "10247", "10248", "10249", "10250", "10251", "10252", "10253", "10254",
                     "10261", "10262", "10263", "10266", "10268", "10269", "10271", "10273", "10276", "10277", "10279",
                     "10285", "10286", "10287", "10288", "10289", "10291", "10293", "10294", "10295", "10296", "10298",
                     "10301", "10305", "10308", "10309", "10310", "10311", "10312", "10313", "10316", "10319", "10322",
                     "10325", "10328", "10330", "10334", "10339", "10341", "10344", "10347", "10348", "10353", "10354",
                     "10355", "10356", "10357", "10358", "10363", "10364", "10367", "10368", "10370", "10371", "10374",
                     "10376", "10384", "10385", "10388", "10389", "10393", "10394", "10400", "10401", "10402", "10403",
                     "10404", "10405", "10407", "10408", "10410", "10411", "10413", "10417", "10419", "10425", "10426",
                     "10431", "10433", "10435", "10436", "10440", "10441", "10445", "10450", "10452", "10453", "10454",
                     "10455", "10456", "10457", "10458", "10460", "10461", "10462", "10466", "10467", "10469", "10470",
                     "10472", "10475", "10476", "10479", "10480", "10481", "10482", "10483", "10489", "10491", "10492",
                     "10493", "10495", "10497", "10500", "10508", "10517", "10519", "10563", "10564", "10566", "10567",
                     "10580", "10581", "10587", "10588", "10591", "10595", "10596", "10597", "10598", "10624", "10630",
                     "10632", "10637", "10648", "10649", "10650", "10651", "10652", "10653", "10656", "10657", "10658",
                     "10668", "10680", "10690", "10698", "10700", "10701", "10702", "10014", "10015", "10016", "10018",
                     "10019", "10021", "10023", "10026", "10033", "10035", "10042", "10043", "9449", "9448", "9441",
                     "9435", "9434", "9429", "9427", "9425", "9424", "9423", "9421", "9419", "9411", "9410", "9409",
                     "9408", "9990", "9989", "9987", "9986", "9976", "9973", "9969", "9967", "9966", "9963", "9954",
                     "9951", "9950", "9944", "9943", "9942", "9941", "9939", "9937", "9936", "9935", "9934", "9933",
                     "9928", "9924", "9922", "9921", "9914", "9912", "9908", "9907", "9906", "9869", "9868", "9867",
                     "9866", "9865", "9858", "9851", "9850", "9849", "9848", "9847", "9842", "9841", "9840", "9839",
                     "9838", "9837", "9834", "9831", "9823", "9819", "9816", "9813", "9812", "9803", "9793", "9791",
                     "9783", "9782", "9779", "9778", "9777", "9776", "9775", "9772", "9771", "9770", "9769", "9768",
                     "9767", "9766", "9764", "9762", "9761", "9760", "9749", "9748", "9744", "9741", "9724", "9722",
                     "9707", "9695", "9679", "9676", "9663", "9662", "9655", "9653", "9651", "9649", "9646", "9640",
                     "9639", "9638", "9637", "9633", "9631", "9630", "9629", "9626", "9620", "9612", "9611", "9602",
                     "9597", "9595", "9592", "9589", "9584", "9583", "9571", "9569", "9568", "9565", "9557", "9543",
                     "9539", "9538", "9525", "9524", "9523", "9521", "9520", "9519", "9517", "9516", "9515", "9514",
                     "9513", "9512", "9511", "9510", "9509", "9508", "9507", "9506", "9505", "9503", "9502", "9501",
                     "9493", "9491", "9490", "9489", "9487", "9481", "9480", "9479", "9478", "9477", "9476", "9475",
                     "9474", "9473", "9472", "9471", "9470", "9469", "9468", "9467", "9466", "9465", "9464", "9462",
                     "9460", "9459", "9458", "9457", "9453", "10754", "10759", "10762", "10764", "10765", "10767",
                     "10770", "10771", "10774", "10775", "10777", "10781", "10705", "10706", "10720", "10737", "10738",
                     "10739", "10741", "10748", "9234", "9233", "9232", "9231", "9230", "9229", "9227", "9216", "9215",
                     "9205", "9204", "9203", "9132", "9131", "9130", "9125", "9123", "9112", "9020", "8822", "8816",
                     "8810", "8808", "8807", "8806", "8804", "8800", "8798", "8694", "8689", "8688", "8687", "8686",
                     "8685", "8684", "9407", "9406", "9405", "9404", "9403", "9402", "9399", "9398", "9397", "9396",
                     "9395", "9394", "9393", "9390", "9388", "9387", "9386", "9384", "9383", "9382", "9381", "9380",
                     "9379", "9378", "9377", "9376", "9375", "9373", "9372", "9371", "9370", "9369", "9368", "9367",
                     "9366", "9365", "9364", "9363", "9362", "9361", "9360", "9359", "9358", "11379", "11378", "11377",
                     "11371", "11370", "11368", "11367", "11366", "11361", "11360", "11359", "11358", "11354", "11351",
                     "11350", "11348", "11346", "11344", "11342", "11341", "11340", "11333", "11331", "11330", "11324",
                     "11322", "11320", "11317", "11315", "11313", "11307", "11306", "11298", "11297", "11296", "11290",
                     "11286", "11281", "11277", "11273", "11272", "11270", "11269", "11268", "11262", "11260", "11463",
                     "11459", "11457", "11454", "11453", "11450", "11449", "11448", "11447", "11446", "11445", "11444",
                     "11443", "11442", "11441", "11434", "11433", "11432", "11431", "11430", "11429", "11428", "11427",
                     "11426", "11424", "11422", "11421", "11417", "11413", "11410", "11406", "11405", "11404", "11400",
                     "11399", "11398", "11397", "11396", "11395", "11394", "11393", "11391", "11390", "11388", "11385",
                     "11384", "11381", "11588", "11587", "11586", "11579", "11578", "11577", "11569", "12194", "12189",
                     "12183", "12174", "12163", "12152", "12146", "12144", "11545", "11544", "11543", "11534", "11533",
                     "11531", "11523", "11522", "11520", "11516", "11513", "11512", "11507", "11506", "11503", "11497",
                     "11494", "11492", "11491", "11490", "11489", "11483", "11482", "11481", "11480", "11474", "11473",
                     "11472", "11471", "11470", "11467", "11466", "11802", "11798", "11797", "11796", "11795", "11794",
                     "11793", "11792", "11791", "11790", "11789", "11788", "11785", "11784", "11775", "11770", "11750",
                     "11749", "11748", "11747", "11740", "11739", "11736", "11735", "11734", "11732", "11731", "11730",
                     "11729", "11726", "11722", "11721", "11717", "11715", "11713", "11707", "11684", "11647", "11617",
                     "11609", "11605", "11603", "11602", "11594", "11593", "11592", "11591", "11940", "11931", "11929",
                     "11913", "11906", "11904", "11903", "11902", "11895", "11893", "11892", "11889", "11886", "11884",
                     "11877", "11876", "11871", "11870", "11868", "11866", "11862", "11861", "11860", "11858", "11855",
                     "11852", "11849", "11848", "11845", "11844", "11843", "11842", "11841", "11840", "11838", "11827",
                     "11826", "11825", "11814", "11813", "11812", "11808", "11807", "11806", "11805", "11804", "11803",
                     "12093", "12090", "12083", "12072", "12070", "12067", "12066", "12064", "12062", "12058", "12057",
                     "12055", "12053", "12050", "12045", "12043", "12037", "12036", "12035", "12031", "12030", "12029",
                     "12027", "12025", "12024", "12015", "12014", "12008", "12006", "12003", "12002", "12001", "11997",
                     "11995", "11991", "11990", "11986", "11983", "11978", "11969", "11964", "11963", "11960", "11951",
                     "11946", "11945", "11944", "10902", "10901", "10900", "10899", "10873", "10872", "10871", "10868",
                     "10865", "10854", "10847", "10842", "10804", "10803", "10802", "10801", "10800", "10796", "10794",
                     "10792", "11011", "11010", "11009", "11008", "11006", "11004", "10990", "10986", "10985", "10984",
                     "10983", "10982", "12140", "12139", "12138", "12131", "12130", "12127", "12116", "12110", "12109",
                     "12108", "12107", "12105", "12099", "12096", "12095", "9357", "9356", "9355", "9354", "9353",
                     "9352", "9351", "9350", "9349", "9348", "9341", "9340", "9336", "9331", "9313", "9312", "9302",
                     "9301", "9298", "9270", "9958", "10980", "10979", "10978", "10976", "10975", "10974", "10973",
                     "10972", "10954", "10953", "10949", "10946", "10945", "10943", "10930", "10927", "10924", "10923",
                     "10921", "10918", "10917", "10916", "10908", "10907", "10905", "10904", "11256", "11035", "11048",
                     "11052", "11053", "11057", "11063", "11064", "11067", "11076", "11077", "11080", "11082", "11093",
                     "11094", "11095", "11096", "11097", "11098", "11100", "11101", "11102", "11103", "11104", "11105",
                     "11106", "11107", "11112", "11113", "11119", "11120", "11121", "11122", "11124", "11125", "11126",
                     "11128", "11135", "11137", "11219", "9970", "9971", "9972", "9975", "9988", "9991", "9992",
                     "9993", "9994", "9995", "9996", "9999", "9710", "9711", "9713", "9714", "9715", "9716", "9723",
                     "9742", "9743", "9745", "9746", "9747", "9753", "9759", "9780", "9792", "9795", "9797", "9809",
                     "9810", "9811", "9814", "9817", "9818", "9833", "9836", "9870", "9905", "9913", "9915", "9925",
                     "9926", "9931", "9938", "9952", "9955", "9708", "9694", "9691", "9680", "9678", "9675", "9674",
                     "9669", "9668", "9667", "9665", "9658", "9650", "9643", "9642", "9641", "9636", "9625", "9623",
                     "9622", "9621", "9619", "9618", "9617", "9616", "9615", "9614", "9613", "9609", "9604", "9603",
                     "9600", "9599", "9598", "9596", "9590", "9588", "9586", "9582", "9580", "9578", "9577", "9573",
                     "9570", "9563", "9562", "9560", "9559", "9537", "9536", "9535", "9532", "9530", "9528", "9527",
                     "9498", "9451", "9447", "9439", "9416", "9415", "9414", "9334", "9332", "9329", "9328", "9327",
                     "9326", "9321", "9320", "9310", "9309", "9306", "9293", "9288", "9283", "9264", "9263", "9261",
                     "9260", "9257", "9256", "9255", "9254", "9253", "9250", "9249", "9248", "9247", "9246", "9245",
                     "9244", "9243", "9242", "9241", "9240", "9239", "9237", "9235", "9224", "9222", "9221", "9218",
                     "9217", "9208", "9207", "9206", "9201", "9197", "9196", "9194", "9191", "9181", "9179", "9178",
                     "9177", "9171", "9170", "9167", "9160", "9159", "9158", "9156", "9146", "9145", "9144", "9143",
                     "9141", "9140", "9139", "9138", "9137", "9136", "9134", "9133", "9129", "9124", "9117", "9113",
                     "9111", "9105", "9057", "9051", "9050", "9045", "9044", "9043", "9040", "9038", "9036", "9034",
                     "9032", "9031", "9030", "9029", "9028", "9027", "9023", "9016", "9013", "9011", "9006", "9005",
                     "9002", "9000", "8997", "8990", "8987", "8985", "8983", "8982", "8979", "8978", "8971", "8970",
                     "8965", "8964", "8962", "8961", "8957", "8954", "8951", "8950", "8944", "8943", "8934", "8929",
                     "8926", "8901", "8900", "8898", "8897", "8896", "8895", "8893", "8887", "8886", "8885", "8884",
                     "8859", "8858", "8795", "8794", "8790", "8786", "8785", "8784", "8782", "8777", "8776", "8774",
                     "8773", "8768", "8765", "8764", "8763", "8755", "8732", "8731", "8724", "8721", "8718", "8716",
                     "8715", "8710", "8709", "8708", "8706", "8705", "8703", "8701", "8699", "8697", "8695", "8692",
                     "8679", "8664", "8661", "8659", "8656", "8653", "11253", "11251", "11250", "11249", "11248",
                     "11246", "11245", "11241", "11229", "11228", "11226", "11225", "11220", "11212", "11210", "11207",
                     "11206", "11203", "11201", "11191", "11188", "11172", "11163", "11161", "11153", "11150", "11149",
                     "11148", "11145", "11144", "11142", "11141", "11140", "11139", "11138", "11567", "11561", "11549",
                     "11012", "11016", "11017", "11019", "11020", "11024", "11025", "11026", "11034", "8650", "10779",
                     "10786", "10787", "10788", "10790", "10791", "10795", "10797", "10798", "10799", "10811", "10812",
                     "10813", "10814", "10815", "10816", "10817", "10818", "10819", "10820", "10821", "10822", "10823",
                     "10824", "10825", "10826", "10827", "10828", "10829", "10830", "10831", "10832", "10833", "10834",
                     "10835", "10836", "10837", "10838", "10839", "10840", "10841", "10843", "10846", "10848", "10850",
                     "10851", "11069", "11070", "11071", "11074", "11075", "11078", "11079", "11083", "11084", "11085",
                     "11087", "11089", "11092", "11108", "11117", "11118", "10684", "10685", "10686", "10687", "10688",
                     "10693", "10694", "10695", "10696", "10699", "10707", "10713", "10714", "10718", "10722", "10723",
                     "10724", "10728", "10729", "10730", "10742", "10743", "10745", "10746", "10749", "10750", "10751",
                     "10752", "10753", "10776", "10778", "10625", "10626", "10627", "10628", "10629", "10634", "10636",
                     "10638", "10639", "10640", "10641", "10642", "10643", "10644", "10646", "10647", "10655", "10660",
                     "10661", "10663", "10664", "10672", "10673", "10674", "10675", "10677", "10678", "10683", "10001",
                     "10002", "10003", "10004", "10005", "10006", "10007", "10012", "10022", "10030", "10032", "10034",
                     "11050", "11056", "11058", "11060", "11061", "11065", "11068", "10545", "10546", "10547", "10548",
                     "10549", "10550", "10551", "10552", "10553", "10554", "10555", "10556", "10557", "10559", "10560",
                     "10561", "10565", "10569", "10573", "10574", "10575", "10576", "10577", "10579", "10582", "10583",
                     "10584", "10585", "10586", "10602", "10603", "10604", "10605", "10606", "10608", "10610", "10611",
                     "10612", "10613", "10614", "10615", "10616", "10617", "10618", "10619", "10621", "10623", "10428",
                     "10429", "10430", "10434", "10439", "10442", "10444", "10451", "10468", "10471", "10474", "10486",
                     "10490", "10494", "10496", "10499", "10501", "10502", "10504", "10505", "10509", "10510", "10512",
                     "10515", "10520", "10522", "10523", "10524", "10525", "10527", "10528", "10529", "10530", "10531",
                     "10532", "10533", "10534", "10535", "10536", "10537", "10538", "10539", "10540", "10541", "10542",
                     "10543", "10544", "10238", "10242", "10245", "10246", "10264", "10265", "10275", "10278", "10281",
                     "10284", "10290", "10297", "10300", "10302", "10306", "10307", "10315", "10317", "10321", "10323",
                     "10324", "10326", "10329", "10332", "10333", "10335", "10342", "10345", "10346", "10350", "10366",
                     "10369", "10372", "10375", "10378", "10381", "10382", "10383", "10391", "10392", "10399", "10406",
                     "10415", "10418", "10420", "10421", "10423", "8600", "8601", "8500", "8502", "8503", "8511",
                     "8514", "8525", "8534", "8535", "8538", "8539", "10036", "10039", "10040", "10041", "10049",
                     "10055", "10056", "10060", "10061", "10064", "10067", "10068", "10069", "10075", "10080", "10087",
                     "10091", "10102", "10103", "10105", "10114", "10121", "10122", "10134", "10138", "10181", "10184",
                     "10194", "10202", "10204", "10206", "10208", "10218", "10219", "10237", "8649", "8648", "8647",
                     "8646", "8645", "8641", "8640", "8637", "8636", "8635", "8634", "8629", "8628", "8626", "8625",
                     "8623", "8616", "8614", "8613", "8610", "8606", "8604", "8603", "8542", "8543", "8545", "8547",
                     "8548", "8549", "8551", "8556", "8559", "8564", "8566", "8570", "8573", "8577", "8578", "8580",
                     "8581", "8586", "8587", "8588", "8592", "8595", "8596", "8597", "10852", "12111", "12170",
                     "11236", "11237", "11240", "11242", "11243", "11247", "11254", "11259", "11263", "11283", "11284",
                     "11289", "11301", "11304", "11305", "11308", "11312", "11326", "11362", "11369", "11372", "11376",
                     "11383", "11407", "11537", "11541", "11551", "11552", "11564", "11568", "11570", "11584", "11623",
                     "11626", "11659", "11882", "11954", "12073", "11132", "11152", "11157", "11158", "11159", "12212",
                     "12214", "12225", "12094", "11001", "11002", "11003", "11005", "11007", "11013", "11014", "11022",
                     "11027", "11028", "11029", "11030", "11031", "11032", "11033", "11039", "11049", "11162", "11164",
                     "11165", "11166", "11168", "11169", "11170", "11173", "11174", "11175", "11178", "11180", "11181",
                     "11182", "11185", "11189", "11190", "11192", "11208", "11209", "11211", "11214", "11215", "11216",
                     "11217", "11222", "11227", "11230", "11232", "11235", "10853", "10855", "10857", "10859", "10860",
                     "10861", "10864", "10869", "10870", "10895", "10898", "10906", "10909", "10910", "10915", "10919",
                     "10922", "10926", "10933", "10935", "10936", "10938", "10939", "10940", "10941", "10947", "10950",
                     "10952", "10955", "10956", "10958", "10961", "10962", "10963", "10965", "10967", "10968", "10969",
                     "10987", "10993", "10994", "10995", "10996", "10997", "10998", "10999", "11000"});

         List<TeamWorkFlowArtifact> workflows = new ArrayList<TeamWorkFlowArtifact>();
         if (workflows.isEmpty()) {
            List<Artifact> artifacts =
                  ArtifactQuery.getArtifactListFromAttributeValues(AtsAttributeTypes.LegacyPCRId, legacyIds,
                        CoreBranches.COMMON, legacyIds.size());
            for (Artifact artifact : artifacts) {
               if (artifact.getArtifactType().getGuid().equals("AAMFDjZ1UVAQTXHk2GgA")) {
                  TeamWorkFlowArtifact teamWorkflow = (TeamWorkFlowArtifact) artifact;
                  String legacyId = teamWorkflow.getWorldViewLegacyPCR();
                  if (!dontCreate.contains(legacyId)) {
                     workflows.add(teamWorkflow);
                  }
               }
            }
            Collections.sort(workflows);
            if (reverse) {
               Collections.reverse(workflows);
            }
         }
         return workflows;
      }

      return worldEditor.getWorldComposite().getXViewer().getSelectedTeamWorkflowArtifacts();
   }

   @Override
   public void run() {
      try {
         IOperation operation = new ExportChangesOperation(getWorkflows());
         Operations.executeAsJob(operation, true);
      } catch (OseeCoreException ex) {
         OseeLog.log(AtsPlugin.class, Level.SEVERE, ex.toString(), ex);
      }
   }

   @Override
   public ImageDescriptor getImageDescriptor() {
      return ImageManager.getImageDescriptor(FrameworkImage.EXPORT_DATA);
   }

   public void updateEnablement() throws OseeCoreException {
      setEnabled(!getWorkflows().isEmpty());
   }

   private static final class ExportChangesOperation extends AbstractOperation {
      private final Collection<TeamWorkFlowArtifact> workflows;

      public ExportChangesOperation(Collection<TeamWorkFlowArtifact> workflows) {
         super("Exporting Change Report(s)", AtsPlugin.PLUGIN_ID);
         this.workflows = workflows;
      }

      private TransactionRecord pickTransaction(IArtifact workflow) throws OseeCoreException {
         int minTransactionId = -1;
         for (TransactionRecord transaction : TransactionManager.getCommittedArtifactTransactionIds(workflow)) {
            if (minTransactionId < transaction.getId()) {
               minTransactionId = transaction.getId();
            }
         }
         if (minTransactionId == -1) {
            throw new OseeStateException("no transaction records found for " + workflow);
         }
         return TransactionManager.getTransactionId(minTransactionId);
      }

      @Override
      protected void doWork(IProgressMonitor monitor) throws Exception {
         for (Artifact workflow : workflows) {
            AtsBranchManager atsBranchMgr = ((TeamWorkFlowArtifact) workflow).getBranchMgr();

            Collection<Change> changes = new ArrayList<Change>();
            IOperation operation = null;
            if (atsBranchMgr.isCommittedBranchExists()) {
               operation = ChangeManager.comparedToPreviousTx(pickTransaction(workflow), changes);
            } else {
               Branch workingBranch = atsBranchMgr.getWorkingBranch();
               if (workingBranch != null) {
                  operation = ChangeManager.comparedToParent(workingBranch, changes);
               }
            }
            if (operation != null) {
               doSubWork(operation, monitor, 0.50);
            }
            if (!changes.isEmpty()) {
               String folderName = workflow.getSoleAttributeValueAsString(AtsAttributeTypes.LegacyPCRId, null);
               IOperation subOp = new WordChangeReportOperation(changes, true, folderName);
               doSubWork(subOp, monitor, 0.50);
            } else {
               monitor.worked(calculateWork(0.50));
            }
         }

      }
   }
}
