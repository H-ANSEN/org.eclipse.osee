<?xml version="1.0" encoding="UTF-8"?>
<project name="Osee Common Build Tasks" default="PdeBuild" basedir=".">
	<!-- this ant file is assumed to be located at <workspace>\org.eclipse.osee.support.build\support, basedir will be the same -->

	<target name="PdeBuild">
		<tstamp />
		<property name="topLevelElementType" value="feature" />
		<property name="builder" value="${basedir}" />
		<dirname property="baseLocation" file="${eclipse.launcher}" />
		<dirname property="workspaceLocationSub" file="${basedir}" />
		<dirname property="workspaceLocation" file="${workspaceLocationSub}" />
		<property name="buildDirectory" value="${workspaceLocation}/sandbox" />
		<property name="pdeTarget" value="main" />

		<delete dir="${buildDirectory}/features" />
		<delete dir="${buildDirectory}/repository" />

		<copy todir="${buildDirectory}/maps">
			<fileset file="${basedir}/osee.map" />
		</copy>
		<antcall target="copySupplementalMapFile" />

		<pathconvert property="pdePathPrefix" setonempty="false" pathsep=" ">
			<path>
				<dirset dir="${baseLocation}/plugins" includes="org.eclipse.pde.build_*" />
			</path>
		</pathconvert>

		<ant antfile="${pdePathPrefix}/scripts/build.xml" target="${pdeTarget}" />

		<antcall target="internalPostBuild" />

		<antcall target="copyToUpdatesite" />
	</target>


	<target name="internalPostBuild" if="postBuildFile">
		<ant antfile="${postBuildFile}" target="${postBuildTarget}" />
	</target>

	<target name="copyToUpdatesite" if="update.site">
		<delete failonerror="false">
			<fileset dir="${update.site}" includes="**/*" defaultexcludes="false" />
		</delete>

		<copy todir="${update.site}">
			<fileset dir="${buildDirectory}/repository" />
		</copy>
	</target>

	<target name="copySupplementalMapFile" if="mapFile">
		<copy todir="${buildDirectory}/maps">
			<fileset file="${mapFile}" />
		</copy>
	</target>
</project>